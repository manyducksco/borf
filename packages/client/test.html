<!DOCTYPE html>
<html>
  <head>
    <title>Demo</title>

    <style>
      body {
        padding: 1em;
        margin: 0;
      }

      .example {
        background-color: transparent;
        transition: background-color 200ms;
        margin-bottom: 1em;
        padding: 0.5em;
        border: 1px solid #ccc;
      }

      .example.active {
        background-color: #b6eeb6;
      }

      .follower {
        width: 32px;
        height: 32px;
        border-radius: 50px;
        background-color: red;
        position: fixed;
        top: 0;
        left: 0;
      }

      .input-group {
        display: flex;
        flex-flow: column nowrap;
        margin-bottom: 1em;
      }

      .input-group h3 {
        padding: 0;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <div id="router-test">
      <a href="/test/5?other=ok">Test</a>
      <a href="https://www.duckduckgo.com">External</a>
    </div>

    <script type="module">
      import {
        State,
        Source,
        Router,
        E,
        $map,
        $when,
        $text,
        HTTP,
      } from "./dist/main.modern.js";

      const req = HTTP.get(
        "https://dog.ceo/api/breeds/image/random",
        async (ctx, next) => {
          await next();
          ctx.body = ctx.body.message;
        }
      );

      req.listen((ctx) => {
        console.log(ctx);
      });

      setTimeout(() => {
        req.reload();
      }, 5000);

      /*===========================*\
      ||        Class Toggle       ||
      \*===========================*/

      class ToggleState extends State {
        toggle() {
          this.set(!this.current);
        }
      }

      function classToggleExample() {
        const active = new ToggleState(false);
        const status = active.map((value) => (value ? "ON" : "OFF"));

        setInterval(() => {
          active.toggle();
        }, 2000);

        return E("div", {
          class: {
            example: true,
            active: active,
          },
          children: [$text(status)],
        });
      }

      /*===========================*\
      ||       Counter + Map       ||
      \*===========================*/

      class CounterState extends State {
        increment() {
          this.set(this.current + 1);
        }

        decrement() {
          this.set(this.current - 1);
        }
      }

      function counterExample() {
        const counter = new CounterState(0);
        const label = counter.map((n) => ` the number is: ${n}`);

        return E("div", {
          class: ["example", "two"],
          children: [
            E("button", {
              onClick() {
                counter.increment();
              },
              children: [$text("Increment")],
            }),
            E("button", {
              onClick() {
                counter.decrement();
              },
              children: [$text("Decrement")],
            }),
            $text(label),
          ],
        });
      }

      /*===========================*\
      ||      Two Way Binding      ||
      \*===========================*/

      function twoWayBindExample() {
        const text = new State("");
        const size = new State(18);

        text.listen(console.log);
        size.listen(console.log);

        return E("div", {
          class: ["example", { three: true }],
          children: [
            E("input", {
              value: text.bind(),
            }),
            E("input", {
              type: "number",
              value: size.bind(),
            }),
            E("p", {
              children: [$text(text, "Type Above")],
              style: {
                fontSize: size.map((s) => `${s}px`),
              },
            }),
          ],
        });
      }

      /*===========================*\
      ||   Conditional Rendering   ||
      \*===========================*/

      function conditionalExample() {
        const show = new ToggleState(false);
        const label = show.map((on) => (on ? "Hide Text" : "Show Text"));

        return E("div", {
          class: ["example", "four"],
          children: [
            E("button", {
              onClick() {
                show.toggle();
              },
              children: [$text(label)],
            }),
            $when(
              show,
              E("span", {
                connected() {
                  console.log("text was mounted");
                },
                disconnected() {
                  console.log("text was unmounted");
                },
                children: [" Hello there!"],
              })
            ),
          ],
        });
      }

      /*===========================*\
      ||      Rendering Lists      ||
      \*===========================*/

      // TODO: Implement 'sort' as a transform function
      function mapExample() {
        const shoppingList = new State([
          "apple",
          "banana",
          "potato",
          "fried chicken",
        ]);

        return E("div", {
          class: ["example", "five"],
          children: [
            E("button", {
              onClick() {
                shoppingList.set(shoppingList.current.map((x) => x).sort());
              },
              children: ["Sort A to Z"],
            }),
            E("button", {
              onClick() {
                shoppingList.set(
                  shoppingList.current
                    .map((x) => x)
                    .sort()
                    .reverse()
                );
              },
              children: ["Sort Z to A"],
            }),
            $map(
              shoppingList,
              (x) => x,
              (item) =>
                E("li", {
                  onClick() {
                    alert(item);
                  },
                  children: [$text(item)],
                })
            ),
          ],
        });
      }

      /*===========================*\
      ||       Mouse Follower      ||
      \*===========================*/

      class MouseSource extends Source {
        paused = false;

        constructor() {
          super({ x: 0, y: 0 });

          window.addEventListener("mousemove", (e) => {
            if (!this.paused) {
              this.value = {
                x: e.pageX,
                y: e.pageY,
              };
              this.broadcast();
            }
          });
        }
      }

      // every X ms pass the function the old state and take its return value as the next state
      // const num = new TickState(1, 300, (n) => n + 1);

      function getRandomHex() {
        const hex = [
          Math.random() * 256,
          Math.random() * 256,
          Math.random() * 256,
        ]
          .map(Math.floor)
          .map((n) => n.toString(16))
          .join("");

        return "#" + hex;
      }

      function mouseFollowerExample() {
        const enabled = new ToggleState(false);
        const mouse = new MouseSource();
        const backgroundColor = new State("#ff0088");
        const transform = mouse.map((m) => `translate(${m.x}px, ${m.y}px)`);

        const bestColor = "#ff0088";
        const notBestColor = backgroundColor.map(
          (hex) => hex.toLowerCase() !== bestColor
        );

        mouse.paused = !enabled.current;

        // pause mouse listener when disabled
        enabled.listen((value) => {
          mouse.paused = !value;
        });

        return exampleSection({
          class: ["mouse-follower"],
          children: [
            // TODO: Optimize - unsubscribe while component is not mounted
            $when(
              enabled,
              E("div", {
                class: "follower",
                style: {
                  transform,
                  backgroundColor,
                },
              })
            ),

            E("button", {
              onClick: () => {
                backgroundColor.set(getRandomHex());
              },
              children: [$text("Change Follower Color")],
              disabled: enabled.map((x) => !x),
            }),
            $when(
              notBestColor,
              E("button", {
                onClick: () => backgroundColor.set(bestColor),
                disabled: enabled.map((x) => !x),
                children: [$text("Reset To Best Color")],
              })
            ),
            E("button", {
              onClick: () => enabled.toggle(),
              children: [
                $text(
                  enabled.map((x) =>
                    x ? "Turn Off Follower" : "Turn On Follower"
                  )
                ),
              ],
            }),
          ],
        });
      }

      // Example of a component function
      function exampleSection(props) {
        return E("div", {
          class: ["example", props.class],
          children: [...(props.children || [])],
        });
      }

      /*===========================*\
      ||           Render          ||
      \*===========================*/

      const component = E("div", {
        children: [
          classToggleExample(),
          counterExample(),
          twoWayBindExample(),
          conditionalExample(),
          mapExample(),
          mouseFollowerExample(),
        ],
      });

      component.connect(document.getElementById("root"));

      /*===========================*\
      ||          Routing          ||
      \*===========================*/

      const router = new Router();

      router.on(
        "test/:id",
        (route) => {
          // setTimeout(() => {
          //   route.next(route.params.id);
          // }, 500);

          return E("span", {
            children: [
              "TEMPORARY...",
              E("button", {
                onClick: () => {
                  route.next(route.params.id);
                },
                children: ["Click for next route"],
              }),
            ],
          });
        },
        (route, data) => {
          console.log("HELLO", route);

          return E("span", {
            children: [
              "I AM MOUNTED: ",
              data,
              route.switch([
                [
                  "edit",
                  (route) => {
                    return E("span", { children: [route.path] });
                  },
                ],
                [
                  "*",
                  (route) => {
                    console.log(route);
                    route.redirect("edit", { replace: true });
                  },
                ],
              ]),

              // route.switch({
              //   tagName: "span",
              //   class: "some-class",
              //   routes: [
              //     [
              //       "edit",
              //       (route) => {
              //         return E("span", { children: [route.path] });
              //       },
              //     ],
              //     [
              //       "*",
              //       (route) => {
              //         console.log(route);
              //         route.redirect("edit", { replace: true });
              //       },
              //     ],
              //   ],
              // }),
            ],
          });
        }
      );

      router.connect("#router-test");
    </script>
  </body>
</html>
